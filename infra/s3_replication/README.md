# Custom S3 Push

This section has the infrastructure and code to push to an S3 bucket that has the appropriate permissions. 

## Steps:

### Pre-steps

Before using this. Make sure there is an IAM Role that can interface with the Destination bucket in the destination account. You can see an example in `roleDefinitionDestinationExample.json`. This also requires the AWS CLI installed locally. 

## Run the script:

Upload the pushS3Template.yml in Cloudformation:

1. Ensure the following environment variables are set: `AWS_DEFAULT_REGION`, `AWS_ACCOUNT`, `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`.
2. Set `S3_REPLICATE_OTHER_ROLE_ARN` environment variable to the Role ARN in the destination account that will be assumed by our lambda
3. Set `S3_REPLICATE_BUCKET_NAME` environment variable to the bucket name in the destination account.
4. Set `S3_REPLICATE_OTHER_ACCOUNT` environment variable to the destination account ID.
5. Run the script `deploy_s3_replication.sh`. This will pull from your environment variables and create the resources (IAM Role, Cloudwatch event, Lambda). 

## Add the bucket policy

The source bucket in this account needs a policy addition in order for the assuming role to get objects from it. 
1. Add the ReadAccess statement in the statements list inside sourceBucketPolicy.json.tmp to the S3 source bucket policy specified in your account, now. This .tmp was generated by the script based on your environment variables. You can now delete this file.

## Post Script Authorization

Now that the Role is created in the source account, we need to add a trusted entity to the role in the destination account.
1. Upload the contents of `trustRelationshipExample.json.tmp` to the role specified in the env var `S3_REPLICATE_OTHER_ROLE_ARN`
2. Save. You can now delete the .tmp file. 

Note, you will get errors if you do this prior to the AWS Cloudformation script completion. It validates against the role's existence even though it is in another account.

## Test

Go to Lambda and test it out! A sample test is provided in "testInput.json" which can be used in the console. This mechanism is useful for backporting data, too. Simply give it every date you want to backport in the provided format.
